<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Updating Jenkins slaves - Tungsten Fabric for Windows Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../highlight.css" rel="stylesheet">
  <link href="../../theme.css" rel="stylesheet">
  <link href="../../theme_extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Updating Jenkins slaves";
    var mkdocs_page_input_path = "ci_admin_guide/Update_Jenkins_slaves.md";
    var mkdocs_page_url = "/ci_admin_guide/Update_Jenkins_slaves/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Tungsten Fabric for Windows Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Ci admin guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Dependencies/">Dependencies</a>
                </li>
                <li class="">
                    
    <a class="" href="../Infrastructure_backups/">Infrastructure backups</a>
                </li>
                <li class="">
                    
    <a class="" href="../List_of_VMs_in_Windows_CI/">List of all important VMs in Windows CI</a>
                </li>
                <li class="">
                    
    <a class="" href="../Merge_development_to_production/">Merge development to production</a>
                </li>
                <li class="">
                    
    <a class="" href="../Run_gerrit_pipeline_on_github_PR/">Run gerrit pipeline on github PR</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Updating Jenkins slaves</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#updating-jenkins-slaves">Updating Jenkins slaves</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#rolling-out-new-slaves">Rolling out new slaves</a></li>
        
            <li><a class="toctree-l4" href="#updating-existing-slaves">Updating existing slaves</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../Update_Zuul/">Update Zuul</a>
                </li>
                <li class="">
                    
    <a class="" href="../Update_private_docker_registry/">Update private docker registry</a>
                </li>
                <li class="">
                    
    <a class="" href="../Windows_CI_logs_layout/">Windows CI logs layout</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Contrail deployment</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../contrail_deployment/CAD_for_windows_design/">CAD for windows design</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contrail_deployment/Devenv_in_local_env/">Devenv in local env</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contrail_deployment/contrail_deployment_in_ci/">Contrail deployment in ci</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contrail_deployment/contrail_deployment_manual/">Contrail deployment manual</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Developer guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../developer_guide/HNS_error_bestiary/">HNS error bestiary</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Building</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../developer_guide/building/Dockerized_builder_using_ansible/">Dockerized builder using ansible</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Style guides</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../style_guides/C/">C</a>
                </li>
                <li class="">
                    
    <a class="" href="../../style_guides/Cpp/">Cpp</a>
                </li>
                <li class="">
                    
    <a class="" href="../../style_guides/Go/">Go</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Updating documentation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../updating_documentation/How_to_update_this_documentation/">How to update this documentation</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../user_guide/caveats/">Caveats</a>
                </li>
                <li class="">
                    
    <a class="" href="../../user_guide/connection_scenarios/">Connection scenarios</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Windows compute</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../windows_compute/Communication_Agent_Extension/">Communication Agent Extension</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Container_creation_lifecycle/">Container creation lifecycle</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Docker_on_Windows/">Docker on Windows</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Forwarding_extension/">Forwarding extension</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/HyperV_extensible_switch/">HyperV extensible switch</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Linux_Overview/">Linux Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Network_creation_lifecycle/">Network creation lifecycle</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Root_HNS_network/">Root HNS network</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/Utility_tools/">Utility tools</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/_Blueprint/"> Blueprint</a>
                </li>
                <li class="">
                    
    <a class="" href="../../windows_compute/vRouter_Linux_implementation/">vRouter Linux implementation</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Tungsten Fabric for Windows Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Ci admin guide &raquo;</li>
        
      
    
    <li>Updating Jenkins slaves</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="updating-jenkins-slaves">Updating Jenkins slaves</h1>
<h2 id="rolling-out-new-slaves">Rolling out new slaves</h2>
<p>TODO
- update templates
- create templates
- spawn new slaves
- decomission old slaves
- tags
- how to test if it worked safely</p>
<h2 id="updating-existing-slaves">Updating existing slaves</h2>
<p>Some minor maintenance work does not require rollout of new slaves. An example might be an
upgrade of some library or other dependency. In this case, one can update the running cluster
without having to create a new template and rolling out every machine. However, the template must
be updated at the end of the procedure, so that future fresh machines will also have the
required changes.</p>
<p>The upgrade procedure consists of:
1. Manually upgrade a subset of nodes
1. Test if CI job pass on the new set of nodes
1. Upgrade the rest of the nodes</p>
<h3 id="1-manually-upgrade-a-subset-of-nodes">1. Manually upgrade a subset of nodes</h3>
<ol>
<li>Select one Jenkins slave to use.<ol>
<li>Make sure that there are other slaves that perform the same function (they have the same tags and are up).</li>
<li>In Jenkins UI, press <code>Mark this node as temporarily offline</code>, providing the reason.</li>
<li>Note the IP address of the slave.</li>
</ol>
</li>
<li>
<p>Manually run ansible against the node.</p>
<blockquote>
<p>NOTE: this is a one-off role. It doesn't necessarily need to be commited to
version control. Therefore, any "hacks" are allowed. For example, to upgrade
a chocolatey package, in addition to updating the <code>version</code> parameter of
<code>win_chocolatey</code> role, one must also run an additional task of uninstalling
the package first. See examples below.</p>
</blockquote>
<ol>
<li>Checkout <code>github.com/Juniper/contrail-windows-ci</code> repository.</li>
<li>Enter <code>ansible/</code> directory.</li>
<li>Prepare your environment by going through steps described in <code>README.md</code>. </li>
<li>Find the ansible role that is responsible for the upgrade.<ol>
<li>Modify the role to suit your needs. </li>
<li>Add a tag to every task that needs to be executed.</li>
</ol>
</li>
<li>Prepare inventory file.<ol>
<li>Edit file <code>inventory.devel/groups</code>.</li>
<li>Add IP of your selected slave under the correct group.</li>
</ol>
</li>
<li>Create one-off playbook.<ol>
<li>Create an yml file in the root of <code>ansible/</code> dir.</li>
<li>Specify hosts and roles to be executed.</li>
</ol>
</li>
<li>Run the playbook, specifying ansible vault, the inventory and prepared playbook.</li>
<li>Test if the change worked.</li>
<li>Remote into the machine and verify if change was successful.</li>
<li>Test if job passes.<ol>
<li>In Jenkins, go into the selected node view. Remove all tags it has. Add some temporary tag (e.g. 'temp-upgrade').</li>
<li>Open a test pull request to <code>github.com/Juniper/contrail-windows-ci</code><ol>
<li>In its Jenksinfile, replace tags of nodes that you removed on t he node with the temporary tag.</li>
<li>Open the pull request with "do not merge" in the title.</li>
<li>Wait for CI to be triggered normally. Wait for it to pass.</li>
</ol>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>NOTE: the following steps may change depending on case-by-case basic.</p>
</blockquote>
</li>
<li>
<p>Open a normal pull request with cleaned up changes to ansible roles.</p>
</li>
<li>Get it merged.</li>
<li>Create a new builder template. (see <a href="#rolling-out-new-slaves">this</a>)</li>
<li>Rollout the change to other slaves by repeating steps 1-2 but specifying larger subsets of nodes.</li>
</ol>
<h4 id="examples">Examples.</h4>
<ol>
<li>Upgrade golang version.</li>
</ol>
<p>ansible/roles/builder/tasks/main.yml:</p>
<pre><code>...
- name: Uninstall golang
  win_chocolatey:
    name: golang
    state: absent
  tags: bump

 - name: Install golang
   win_chocolatey:
     name: golang
     version: 1.10.0
     state: present
  tags: bump
...
</code></pre>

<p>ansible/mysite.yml</p>
<pre><code>---
- name: 'bump golang'
  hosts: 
    - builder
  roles: 
    - builder
</code></pre>

<p>inventory.devel/groups:</p>
<pre><code>...
[builder]
10.84.12.87
...
</code></pre>

<p>Command to run:</p>
<pre><code>ansible-playbook -i inventory.devel --vault-password-file ~/.ansible-vault --tags &quot;bump&quot; mysite.yml
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Update_Zuul/" class="btn btn-neutral float-right" title="Update Zuul">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Run_gerrit_pipeline_on_github_PR/" class="btn btn-neutral" title="Run gerrit pipeline on github PR"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Run_gerrit_pipeline_on_github_PR/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Update_Zuul/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>

</body>
</html>
